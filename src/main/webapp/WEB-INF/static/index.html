<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js" integrity="sha512-ayb5R/nKQ3fgNrQdYynCti/n+GD0ybAhd3ACExcYvOR2J1o3HebiAe/P0oZDx5qwB+xkxuKG6Nc0AFTsPT/JDQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js" integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <script>
        const info = a=>console.info(a);

        var endpointUrl = "/api/ws/end?authToken=";
        var subUrl = "/sub/videos/1/comments";
        var pubUrl = "/pub/videos/1/comments";

        var authToken = "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiIxIiwiZ3JhbnRzIjoiUk9MRV9VU0VSIiwidXNlcl9uYW1lIjoiVVNFUjEiLCJ1c2VyX2lkIjoidXNlcjFAdGVzdC5jb20iLCJleHAiOjE2Mzc1NjgyMDl9.ggTJrWbOyyqJ8HQN91HKRovYSEKtApBBhkhUP-zxKY3HbTW_tLqTlpzZDJGXHgSQf1WzTnsSWdXCvMKYWwWcWA";

        axios.get("/api/users/me/token",{headers: {Authorization : authToken}}).then( response =>{
          return response.data.accessToken;
        }).then(token => {
          endpointUrl = endpointUrl + token;
          connect();
        });
        
var stompClient = null;

function connect() {
  var socket = new SockJS(endpointUrl);

  stompClient = Stomp.over(socket);
  stompClient.debug = null;
  // SockJS와 stomp client를 통해 연결을 시도.
  stompClient.connect(
    {},
    function (frame) {
      console.log('Connected: ' + frame);
      stompClient.subscribe(subUrl, function (data) {
        showGreeting(JSON.parse(data.body));
      });
    },
    function(message) {
      console.log("Disconnected message!");      
    }
  );
}

function disconnect() {
  if (stompClient !== null) {
    stompClient.disconnect();
  }
  console.log("Disconnected");
}

function send(msg) {
  // /app/hello로 JSON 파라미터를 메세지 body로 전송.
  stompClient.send(pubUrl, {}, JSON.stringify({'content': msg}));
  console.log("send : "+ msg);
}

function showGreeting(message) {  
  message.forEach(aL=>console.log(aL))
}

    </script>
</body>
</html>